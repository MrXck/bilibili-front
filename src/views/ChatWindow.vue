<template>    <div class="chat">        <div class="title">{{ withUser.nickname }}</div>        <div class="window" ref="window">            <div v-for="item in messageList">                <OtherSendMessage v-if="item.fromId === withUser.id" :item="item" :user="withUser"/>                <MySendMessage v-if="item.fromId === user.id" :item="item" :user="withUser"/>            </div>        </div>        <div class="send">            <div class="option">                <img @click="clickFile" class="pic" :src="pic" alt="">                <input class="hidden" type="file" @change="uploadFile" ref="file"                       accept="image/gif,image/jpeg,image/jpg,image/png">            </div>            <textarea class="content" v-model="content"></textarea>            <div class="bottom">                <div class="button" @click="sendMessage">                    发送                </div>            </div>        </div>    </div></template><script>import pic from '@/assets/pic.png'import {getCurrentInstance, onBeforeUnmount, onMounted, reactive, ref} from 'vue'import {useRoute} from 'vue-router'import request from '@/utils/request'import {GetMessage, SEND_TEXT_TYPE} from '@/utils/Constant'import OtherSendMessage from '@/components/OtherSendMessage'import MySendMessage from '@/components/MySendMessage'import socket from '@/utils/Socket'export default {    name: 'ChatWindow',    components: {MySendMessage, OtherSendMessage},    setup() {        let file        let route = useRoute()        let pageSize = ref(20)        let messageList = reactive([])        let withUser = ref({})        let isLoading = false        let isEnd = false        let window        let content = ref('')        let user = JSON.parse(localStorage.getItem('user'))        function init() {            request.post(GetMessage, {                pageSize: pageSize.value,                withId: route.params.id,            }).then(res => {                if (res.data.code === 0) {                    messageList.push(...res.data.data.message.reverse())                    withUser.value = res.data.data.user                }            }).finally(() => {                window.scrollTop = window.scrollHeight            })        }        function scrollLoad() {            try {                if (!isLoading && !isEnd) {                    if (window.scrollTop < 50) {                        isLoading = true                        let data = {                            pageSize: pageSize.value,                            id: messageList[0].id,                            withId: route.params.id,                        }                        request.post(GetMessage, data).then(res => {                            if (res.data.code === 0) {                                messageList.unshift(...res.data.data.message.reverse())                                if (res.data.data.message.length === 0) {                                    isEnd = true                                }                            }                        }).finally(() => {                            isLoading = false                        })                    }                }            } catch (e) {            }        }        onMounted(() => {            file = getCurrentInstance().refs.file            window = getCurrentInstance().refs.window            init()            window.addEventListener('scroll', scrollLoad)            socket.onmessage = (e) => {                let message = JSON.parse(e.data)                console.log(e.data)                messageList.push(message)                setTimeout(() => {                    window.scrollTop = window.scrollHeight                }, 10)            }        })        onBeforeUnmount(() => {            window.removeEventListener('scroll', scrollLoad)        })        function clickFile() {            file.click()        }        function uploadFile() {            console.log(file.files[0])            let formData = new FormData()            formData.append('file', file.files[0])            request.post('/file/upload?toId=' + withUser.value.id, formData, {headers: {'Content-Type': 'multipart/form-data'}}).then(res => {                if (res.data.code === 0) {                    let data = res.data.data                    data.token = localStorage.getItem('token')                    socket.send(JSON.stringify(data))                } else {                }            })        }        function sendMessage() {            if (content.value !== '') {                let message = {                    toId: withUser.value.id,                    content: content.value,                    type: SEND_TEXT_TYPE,                    token: localStorage.getItem('token'),                }                socket.send(JSON.stringify(message))                messageList.push(message)                content.value = ''                init()            }        }        return {            pic,            messageList,            withUser,            content,            user,            clickFile,            uploadFile,            sendMessage,        }    },}</script><style scoped>.chat {    height: 100%;    width: 100%;}.window {    width: 100%;    height: calc(100% - 162px - 36px);    overflow-y: auto;    background-color: #f4f5f7;}.send {    width: calc(100% - 32px);    border-top: #d8d8d8 solid 1px;    height: 161px;    padding: 0 16px;    background-color: #f4f5f7;}.option {    height: 48px;    display: flex;    align-items: center;}.content {    height: 60px;    border: none;    outline: none;    resize: none;    width: 100%;    font-size: 14px;    background-color: rgba(0, 0, 0, 0);}.title {    height: 35px;    text-align: center;    line-height: 35px;    border-bottom: #e9eaec solid 1px;}.pic {    cursor: pointer;}.hidden {    display: none;}.bottom {    display: flex;    justify-content: flex-end;    align-items: flex-end;    width: 100%;}.button {    width: 88px;    height: 30px;    display: flex;    justify-content: center;    align-items: center;    background-color: #ffffff;    border: #e7e7e7 solid 1px;    border-radius: 4px;    font-size: 14px;    cursor: pointer;}</style>